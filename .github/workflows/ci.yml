name: Deploy Go App to VPS

on: 
    push:
        branches: ["main"]

jobs:
    build-and-push:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Code
              uses: actions/checkout@v4
            
            - name: Login to Docker hub
              uses: docker/login-action@v3
              with:
                username: ${{ secrets.DOCKER_USER }}
                password: ${{ secrets.DOCKER_TOKEN }}
            - name: Build and Deploy
              run: |
                docker build -t ${{ secrets.DOCKER_USER }}/chripy:latest .
                docker push ${{ secrets.DOCKER_USER }}/chripy:latest
    deploy-to-vps:
        needs: build-and-push
        runs-on: ubuntu-latest
        steps:
          - name: Checkout Code
            uses: actions/checkout@v4

          - name: Prepare Deployment files
            run: |
              # rename files prod in runner
              mv docker-compose.prod.yml docker-compose.yml

              # lakukan konfigurasi file yang lainnya disini
          - name: Copy file to VPS
            uses: appleboy/scp-action@v1
            with:
              host: ${{ secrets.HOST }}
              username: ${{ secrets.USERNAME }}
              key: ${{ secrets.SSH_KEY }}
              # Copy folder schema lokal -> ke folder schema di VPS
              # Copy file compose prod -> jadi docker-compose.yml di VPS
              source: "db/sql/schema/*,docker-compose.yml"
              target: "/root/app/chripy"

          - name: Connect to VPS and Deploy 
            uses: appleboy/ssh-action@master
            with:
              host: ${{ secrets.HOST }}
              username: ${{ secrets.USERNAME }}
              key: ${{ secrets.SSH_KEY }}
              script: |
                # Masuk ke folder
                cd /root/app/chripy
                
                # Jika SCP mengirim 'db/sql/schema', kita pindahkan isinya ke 'schema' root project
                if [ -d "db/sql/schema" ]; then
                  echo "üìÇ Merapikan folder schema..."
                  rm -rf schema
                  mkdir -p schema
                  cp -r db/sql/schema/* schema/
                  rm -rf db  # Bersihkan folder sisa SCP
                fi

                echo "üìù Update file .env..."
                cat <<EOF  > .env 
                ${{ secrets.PROD_ENV_FILE }}
                "DOCKER_IMAGE=${{ secrets.DOCKER_USER }}/chripy:latest" 
                EOF


                chmod 600 .env

                echo "üöÄ Mulai Deploy..."
                echo ${{ secrets.DOCKER_TOKEN }} | docker login -u ${{ secrets.DOCKER_USER }} --password-stdin
                
                docker compose pull

                docker compose up -d --remove-orphans

                echo "üßπ Membersihkan image lama..."
                docker image prune -f
                
                echo "‚úÖ Deployment Selesai!"




              
                
            

