name: Deploy Go App to VPS

on: 
    push:
        branches: ["main"]

jobs:
    build-and-push:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Code
              uses: actions/checkout@v4
            
            - name: Login to Docker hub
              uses: docker/login-action@v3
              with:
                username: ${{ secrets.DOCKER_USER }}
                password: ${{ secrets.DOCKER_TOKEN }}
            - name: Build and Deploy
              run: |
                docker build -t ${{ secrets.DOCKER_USER }}/chripy:latest .
                docker push ${{ secrets.DOCKER_USER }}/chripy:latest
    deploy-to-vps:
        needs: build-and-push
        runs-on: ubuntu-latest
        steps:
          - name: Checkout Code
            uses: actions/checkout@v4
            
          - name: Copy file to VPS
            uses: appleboy/scp-action@master
            with:
              host: ${{ secrets.HOST }}
              username: ${{ secrets.USERNAME }}
              key: ${{ secrets.SSH_KEY }}
              # Copy folder schema lokal -> ke folder schema di VPS
              # Copy file compose prod -> jadi docker-compose.yml di VPS
              source: "db/sql/schema/*,docker-compose.prod.yml"
              target: "/root/app/chripy"
              strip_components: 0

          - name: Connect to VPS and Deploy 
            uses: appleboy/ssh-action@master
            with:
              host: ${{ secrets.HOST }}
              username: ${{ secrets.USERNAME }}
              key: ${{ secrets.SSH_KEY }}
              script: |
                # Masuk ke folder
                cd /root/app/chripy
                
                # --- DEBUGGING START ---
                echo "üìÇ Cek file yang sampai dari SCP:"
                ls -laR
                # -----------------------

                # 1. Rapikan File Docker Compose
                # Pindahkan jika SCP menaruhnya di dalam subfolder (kadang terjadi)
                mv docker-compose.prod.yml docker-compose.yml 2>/dev/null || true
                
                # 2. Rapikan Folder Schema
                # Hapus folder schema tujuan (biar fresh), lalu buat ulang
                rm -rf schema
                mkdir -p schema
                # Copy isi dari folder hasil SCP (db/sql/schema) ke folder volume (schema)
                cp -r db/sql/schema/* schema/ 2>/dev/null || echo "‚ö†Ô∏è Gagal copy schema, cek struktur folder"

                # 3. Buat file .env (Injection)
                echo "üìù Membuat file .env..."
                echo "${{ secrets.PROD_ENV_FILE }}" > .env
                # Tambahkan nama image ke .env
                echo "DOCKER_IMAGE=${{ secrets.DOCKER_USER }}/chripy:latest" >> .env

                # --- DEBUGGING ENV ---
                echo "üîç Cek apakah .env terbentuk:"
                ls -la .env
                # ---------------------

                # 4. Login & Deploy
                echo "üöÄ Mulai Deploy..."
                echo ${{ secrets.DOCKER_TOKEN }} | docker login -u ${{ secrets.DOCKER_USER }} --password-stdin
                
                # Matikan dulu biar bersih (Opsional, tapi aman untuk debugging)
                docker compose down
                
                docker compose pull 
                docker compose up -d --remove-orphans
                
                echo "‚úÖ Deployment Selesai!"




              
                
            

